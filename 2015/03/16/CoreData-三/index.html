<html>
<head>
	
	<title>CoreData(三)</title>
	<meta name="keywords" content="Hi, boring world!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<h6 id="coredata-and-swift-by-yongsir"><a href="#CoreData-and-Swift-by-YongSir&#x1F1E8;&#x1F1F3;&#x1F1E8;&#x1F1F3;" class="headerlink" title="CoreData and Swift by YongSir&#x1F1E8;&#x1F1F3;&#x1F1E8;&#x1F1F3;"></a>CoreData and Swift by YongSir&#x1F1E8;&#x1F1F3;&#x1F1E8;&#x1F1F3;</h6><p><strong>NSFetchRequest is the multi-function Swiss army knife of the Core Data framework!</strong></p>
<p>&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x5C06;&#x96C6;&#x4E2D;&#x4ECB;&#x7ECD;coreData&#x4E2D;fetch&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5728;&#x524D;&#x8FB9;&#x6240;&#x6709;&#x7684;fetch&#x57FA;&#x672C;&#x90FD;&#x662F;&#x4E00;&#x4E2A;&#x5957;&#x8DEF;&#xFF1A;<code>create an instance of NSFetchRequest</code>, <code>configure it and hand it over to NSManagedObjectContext</code>&#xFF0C;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x4E8B;&#x5B9E;&#x4E0A;&#x6709;4&#x79CD;&#x6301;&#x6709;&#x8BF7;&#x6C42;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x4E3A;&#x4E86;&#x4E0D;&#x663E;&#x7A81;&#x5140;&#xFF0C;&#x90FD;&#x5217;&#x4E3E;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 1</span><br><span class="line">let fetchRequest1 = NSFetchRequest()</span><br><span class="line">let entity = NSEntityDescription.entityForName(&quot;XXX&quot;, inManagedObjectContext: managedObjectContext)</span><br><span class="line">fetchRequest1.entity = entity!</span><br><span class="line"></span><br><span class="line">// 2</span><br><span class="line">let fetchRequest2 = NSFetchRequest(entityName: &quot;XXX&quot;)</span><br><span class="line"></span><br><span class="line">// 3</span><br><span class="line">let fetchRequest3 = managedObjectModel.fetchRequestTemplateName(&#x201C;peopleFR&quot;)</span><br><span class="line"></span><br><span class="line">// 4</span><br><span class="line">let fetchRequest4 = managedObjectModel.fetchRequestFromTemplateWithName(&quot;peropleFR&quot;, substitutionVariables:[&quot;NAME&quot; : &quot;Ray&quot;])</span><br></pre></td></tr></table></figure>
<p>&#x5176;&#x5B9E;&#x533A;&#x522B;&#x5E76;&#x4E0D;&#x50CF;&#x60F3;&#x8C61;&#x7684;&#x5927;&#x548C;&#x7A81;&#x5140;&#xFF0C;&#x5BF9;&#x4E8E;request&#x6765;&#x8BF4;&#xFF0C;&#x8DDF;&#x91CD;&#x8981;&#x7684;&#x5728;&#x4E8E;&#x7279;&#x5B9A;&#x7684;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x4E0D;&#x5199;SQL&#x8BED;&#x53E5;&#x4E5F;&#x80FD;&#x64CD;&#x4F5C;&#x6570;&#x636E;&#x3002;&#x4F7F;&#x7528;DemoBubbleTeaFinder&#x6765;&#x5177;&#x4F53;&#x8BF4;&#x660E;&#x5427;</p>
<hr>
<p>&#x9996;&#x5148;&#x662F;&#x521B;&#x5EFA;&#x9879;&#x76EE;&#xFF0C;&#x6DFB;&#x52A0;coreData Stack&#x7B49;&#x7B49;&#x7684;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#xFF0C;&#x597D;&#x5728;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;<br>&#x5148;&#x4ECB;&#x7ECD;&#x4E00;&#x79CD;&#x6700;&#x76F4;&#x63A5;&#x7684;request&#x65B9;&#x5F0F;&#xFF0C;&#x5C31;&#x662F;&#x5229;&#x7528;Xcode&#x7684;data editer&#x6DFB;&#x52A0;requset&#xFF0C;&#x7136;&#x540E;&#x518D;&#x901A;&#x8FC7;&#x4EE3;&#x7801;&#x5173;&#x8054;&#xFF0C;&#x7528;fetchRequest&#x627F;&#x63A5;&#xFF1A;</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x5173;&#x8054;editor&#x7684;request &#xFF0D;&#xFF0D; &#x901A;&#x8FC7;model &#xFF0B; Xcode&#x8F85;&#x52A9;</span></span><br><span class="line">fetchRequest = coreDataStack.model.fetchRequestTemplateForName(<span class="string">&quot;FetchRequest&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x5B83;&#x76F4;&#x63A5;&#x4ECE;NSManagedObjectModele&#xFF0C;&#x901A;&#x8FC7;&#x501F;&#x52A9;Xcode&#x8F85;&#x52A9;&#x800C;&#x6765;&#xFF0C;&#x4F7F;&#x7528;&#x5F02;&#x5E38;&#x7B80;&#x5355;&#xFF1B;</li>
<li>&#x7F3A;&#x70B9;&#x5728;&#x4E8E;&#x5F62;&#x5F0F;&#x56FA;&#x5B9A;&#xFF08;<em>A drawback of stored fetch requests is that there is no way to specify a sort order for the results.</em>&#xFF09;&#xFF0C;&#x4E0D;&#x80FD;&#x591A;&#x4F59;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x6240;&#x6709;&#x5E38;&#x7528;&#x4E8E;&#x9700;&#x8981;&#x53CD;&#x590D;&#x591A;&#x6B21;&#x76F8;&#x540C;&#x7684;request&#x65F6;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5F88;&#x5C11;&#x9047;&#x5230;&#x3002;&#x5982;&#x679C;&#x6267;&#x610F;&#x8981;&#x4F7F;&#x7528;&#xFF0C;&#x90A3;&#x51FA;&#x73B0;&#x8FD9;&#x79CD;&#x9519;&#x8BEF;&#x5C31;&#x4E0D;&#x8981;&#x5947;&#x602A;&#x4E86;&#xFF1A;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Terminating app due to uncaught exception &apos;NSInternalInconsistencyException&apos;, reason: &apos;Can&apos;t modify a named fetch request in an immutable model.&apos;</span><br></pre></td></tr></table></figure>
<hr>
<p>&#x5982;&#x679C;&#x53EA;&#x662F;&#x5355;&#x7EAF;&#x7684;&#x4EE5;&#x4E3A;request&#x53EA;&#x662F;&#x5355;&#x7EAF;&#x7684;&#x83B7;&#x53D6;&#x6570;&#x636E;&#xFF0C;&#x90A3;&#x5C31;&#x5927;&#x9519;&#x7279;&#x9519;&#x4E86;&#xFF0C;&#x5B83;&#x7684;&#x529F;&#x80FD;&#x4E0D;&#x6B62;&#x5982;&#x6B64; &#xFF1A;You can use it to fetch individual values, compute statistics on your data such as the average, minimum and maximum, and more.&#x5B83;&#x62E5;&#x6709;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x89C4;&#x5B9A;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x7684;&#x5C5E;&#x6027;NSManagedObjectResultType &#xFF0C;&#x6709;&#x56DB;&#x79CD;&#x7C7B;&#x578B;&#xFF1A;</p>
<ul>
<li><strong>NSManagedObjectResultType</strong>: Returns managed objects (default value).</li>
<li><strong>NSCountResultType</strong>: Returns the count of the objects that match the fetch request.</li>
<li><strong>NSDictionaryResultType</strong>: This is a catch-all return type for returning the results of different calculations.</li>
<li><strong>NSManagedObjectIDResultType</strong>: Returns unique identifiers instead of full- fledged managed objects.</li>
</ul>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x4F7F;&#x7528;countResultType&#xFF0C;Demo&#x4E2D;&#x7684;Filters&#x754C;&#x9762;&#xFF0C;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x662F;&#x6309;&#x7167;&#x7ED9;&#x5B9A;&#x7684;&#x6807;&#x8BB0;&#x5F52;&#x6863;&#x5206;&#x7C7B;&#xFF0C;&#x7ED9;&#x51FA;&#x5F53;&#x524D;&#x6700;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;&#x5E97;&#x5740;&#xFF0C;&#x5176;&#x4E2D;&#x7684;PRICE&#x90E8;&#x5206;&#xFF0C;&#x662F;&#x6839;&#x636E;&#x4EF7;&#x683C;&#x5206;&#x7C7B;&#x7684;&#xFF1A;</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// &#x4F7F;&#x7528;CountResultType&#x65B9;&#x5F0F;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x53EA;&#x5305;&#x542B;&#x603B;&#x6570;&#x76EE;&#x7684;&#x6570;&#x7EC4;</span></span><br><span class="line">  <span class="comment">// &#x5F53;&#x7136;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x6240;&#x6709;&#x7684;[Venue],&#x5728;&#x5F97;&#x51FA;&#x6570;&#x91CF;&#xFF0C;&#x4F46;&#x5F53;&#x6570;&#x636E;&#x5DE8;&#x5927;&#x65F6;&#xFF0C;</span></span><br><span class="line">  <span class="comment">// CountResultType&#x65B9;&#x5F0F;&#x5C31;&#x662F;&#x4E00;&#x79CD;&#x9AD8;&#x6548;&#x7684;&#x9009;&#x62E9;&#xFF08;is more memory- efficient&#xFF09;</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">populateCheapVenueCountLable</span><span class="params">()</span></span> {</span><br><span class="line">     <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>(entityName: <span class="string">&quot;Venue&quot;</span>)</span><br><span class="line">     fetchRequest.resultType = <span class="type">NSFetchRequestResultType</span>.<span class="type">CountResultType</span></span><br><span class="line">     fetchRequest.predicate = cheapVenuePredicate</span><br><span class="line">     <span class="comment">// &#x6267;&#x884C;&#x8BF7;&#x6C42;</span></span><br><span class="line">      <span class="keyword">do</span> {</span><br><span class="line">          <span class="keyword">let</span> results = <span class="keyword">try</span>           coreDataStack.context.executeFetchRequest(fetchRequest) <span class="keyword">as</span>! [<span class="type">NSNumber</span>]</span><br><span class="line">     <span class="comment">// &#x4ECE;&#x6570;&#x7EC4;&#x4E2D;&#x53D6;&#x51FA;</span></span><br><span class="line">          <span class="keyword">let</span> <span class="built_in">count</span> = results[<span class="number">0</span>].integerValue</span><br><span class="line">          firstPriceCategoryLabel.text = <span class="string">&quot;\(count) bubbke tea places&quot;</span></span><br><span class="line">           }<span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> {</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;&#x672A;&#x80FD;&#x6210;&#x529F;&#x83B7;&#x53D6;\(error) ,\(error.userInfo)&quot;</span>)</span><br><span class="line">      }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;<code>NSCountResultType</code>&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x201C;&#xFF3B;12&#xFF3D;&#x201D;&#xFF0C;&#x4F46;&#x8FD9;&#x4E2A;&#x6570;&#x7EC4;&#x53EA;&#x542B;&#x6709;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x6B64;&#x5916;&#x4E0D;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x9879;&#x76EE;&#x90FD;&#x52A0;&#x8F7D;&#xFF0C;&#x5728;&#x5904;&#x7406;&#x5927;&#x91CF;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x662F;&#x4E00;&#x79CD;&#x9AD8;&#x6548;&#x7684;&#x5F97;&#x5230;&#x6570;&#x91CF;&#x7684;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x5728;Offering a deal&#x6761;&#x76EE;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x5F97;&#x5230;&#x4EA4;&#x6613;&#x6570;&#x76EE;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;JSON&#x4E2D;&#x5404;&#x4E2A;&#x4E0D;&#x540C;&#x5E97;&#x94FA;&#x7684;specialCount&#x5B57;&#x6BB5;&#x4E0B;&#x7684;&#x503C;&#x7684;&#x548C;&#xFF0C;&#x5F53;&#x7136;&#x628A;&#x6240;&#x6709;&#x7684;&#x5E97;&#x94FA;&#x4FE1;&#x606F;&#x5168;&#x90E8;&#x53D6;&#x51FA;&#x6765;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;for&#x5FAA;&#x73AF;&#x53BB;&#x6C42;&#x548C;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#xFF0C;&#x4F46;&#x8003;&#x8651;&#x5230;&#x5927;&#x91CF;&#x6570;&#x636E;&#x7684;&#x60C5;&#x5F62;&#x5C31;&#x4E0D;&#x884C;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;coreData&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4E86;<code>NSDictionaryResultType</code>&#x8FD9;&#x79CD;&#x7C7B;&#x578B;&#xFF0C;&#x4F1A;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684;&#x8BA1;&#x7B97;&#x540E;&#x7684;&#x7ED3;&#x679C;&#xFF0C; has built-in support for a number of different functions such as average, sum, min and max.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">populateDealsCountLabel</span><span class="params">()</span></span> {</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 1 &#x4F7F;&#x7528;DictionaryResultType&#x65B9;&#x5F0F;--&#x5373;&#x662F;&#x4EE5;NSDictionary&#x7684;&#x683C;&#x5F0F;&#x7EC4;&#x7EC7;&#x8FD4;&#x56DE;          &#x7684;&#x6570;&#x636E;</span></span><br><span class="line">     <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>(entityName: <span class="string">&quot;Venue&quot;</span>)</span><br><span class="line">     fetchRequest.resultType = <span class="type">NSFetchRequestResultType</span>.<span class="type">DictionaryResultType</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 2 &#x521B;&#x5EFA;NSExpressionDescription&#xFF0C;&#x5E76;&#x547D;&#x540D;</span></span><br><span class="line">     <span class="keyword">let</span> sumExpressionDesc = <span class="type">NSExpressionDescription</span>()</span><br><span class="line">     sumExpressionDesc.name = <span class="string">&quot;sumDeals&quot;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 3 &#x622A;&#x53D6;specialCount&#x5B57;&#x6BB5;&#xFF0C;&#x5E76;&#x505A;sum&#x8BA1;&#x7B97;</span></span><br><span class="line">     sumExpressionDesc.expression = <span class="type">NSExpression</span>(forFunction: <span class="string">&quot;sum:&quot;</span>, arguments: [<span class="type">NSExpression</span>(forKeyPath: <span class="string">&quot;specialCount&quot;</span>)])</span><br><span class="line">     sumExpressionDesc.expressionResultType = <span class="type">NSAttributeType</span>.<span class="type">Integer32AttributeType</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 4 &#x914D;&#x7F6E;&#x8BF7;&#x6C42;:propertiesToFetch&#x5C5E;&#x6027;&#x8D4B;&#x503C;</span></span><br><span class="line">      fetchRequest.propertiesToFetch = [sumExpressionDesc]</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 5 &#x6267;&#x884C;&#x8BF7;&#x6C42; &#xFF0B; &#x66F4;&#x65B0;UI</span></span><br><span class="line">     <span class="keyword">do</span> {</span><br><span class="line">         <span class="keyword">let</span> results = <span class="keyword">try</span>           coreDataStack.context.executeFetchRequest(fetchRequest) <span class="keyword">as</span>! [<span class="type">NSDictionary</span>]</span><br><span class="line">          <span class="comment">// &#x5B9E;&#x9645;&#x4E0A;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x5B57;&#x5178;&#x7684;&#x6570;&#x7EC4; &#xFF3B;{sumDeals &#xFF1D; 12;}&#xFF3D;</span></span><br><span class="line">         <span class="keyword">let</span> resultDict = results[<span class="number">0</span>]</span><br><span class="line">         <span class="built_in">print</span>(results)</span><br><span class="line">         <span class="keyword">let</span> numDeals: <span class="type">AnyObject</span>? = resultDict[<span class="string">&quot;sumDeals&quot;</span>]</span><br><span class="line">         numDealsLabel.text = <span class="string">&quot;\(numDeals!) total deals&quot;</span></span><br><span class="line">     }<span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span>{</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">&quot;&#x672A;&#x80FD;&#x6210;&#x529F;&#x83B7;&#x53D6;&#x6298;&#x6263;&#x6570;&#x91CF;\(error),\(error.userInfo)&quot;</span>)</span><br><span class="line">     }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5176;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x548C;&#x914D;&#x7F6E;<code>NSExpressionDescription</code>&#xFF0C;&#x8BBE;&#x7F6E;<code>propertiesToFetch</code>&#x5C5E;&#x6027;&#xFF0C;&#x6267;&#x884C;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#x662F;&#x4E00;&#x4E2A;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x5B57;&#x5178;&#x7684;&#x6570;&#x7EC4;<em>&#xFF3B;{sumDeals &#xFF1D; 12;}&#xFF3D;</em>&#x3002;&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;&#x7531;&#x4E8E;&#x4EE3;&#x7801;&#x7684;&#x4E0D;&#x76F4;&#x89C2;&#xFF0C;&#x9664;&#x975E;&#x5904;&#x4E8E;&#x6027;&#x80FD;&#x4E0A;&#x7684;&#x8003;&#x8651;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x7528;&#x6CD5;&#x5E76;&#x4E0D;&#x5E38;&#x89C1;&#xFF1A;</p>
<blockquote>
<p>Fetching a calculated value from Core Data requires you to follow many, often unintuitive steps, so make sure you have a good reason for using this technique&#x2014; like performance considerations.</p>
</blockquote>
<p>&#x81F3;&#x5C11;&#x73B0;&#x5728;&#x5DF2;&#x7ECF;&#x7528;&#x8FC7;&#x4E86;3&#x79CD;&#x65B9;&#x5F0F;&#xFF08;&#x597D;&#x5427;&#xFF0C;&#x5176;&#x5B9E;&#x662F;2&#x79CD;&#xFF09;&#xFF0C;&#x8FD8;&#x6709;&#x6700;&#x540E;&#x4E00;&#x79CD;<code>NSManagedObjectIDResultType</code>&#xFF0C;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x7EC4;&#x7B26;&#x5408;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;&#x67E5;&#x627E;&#x5230;&#x7684;&#x6258;&#x7BA1;&#x7684;&#x6570;&#x636E;&#x201C;&#xFF3B;ID&#x2026;&#xFF3D;&#x201D;&#xFF0C;&#x5C31;&#x50CF;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;id&#x4E00;&#x6837;&#x3002;&#x5728;ios5&#x4E4B;&#x540E;&#x7684;&#x5E76;&#x53D1;&#x6280;&#x672F;&#x5F15;&#x5165;&#x4EE5;&#x540E;&#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5C31;&#x66F4;&#x5C11;&#x89C1;&#x5230;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x57FA;&#x672C;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#x3002;</p>
<blockquote>
<p>When you fetch with this type, the result is an array of NSManagedObjectID objects rather the actual managed objects they represent. An NSManagedObjectID is a compact, universal identifier for a managed object. It works like the primary key in the database!</p>
</blockquote>
<hr>
<p>&#x5728;&#x8865;&#x5168;Files&#x4E2D;&#x7684;&#x5269;&#x4F59;&#x6761;&#x76EE;&#x4E4B;&#x524D;&#xFF0C;&#x5148;&#x6765;&#x601D;&#x8003;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<p>You&#x2019;ve gotten a taste of all the things a fetch request can do for you. <em>But just as important as the information a fetch request returns is the information it doesn&#x2019;t return. For practical reasons, you have cap the incoming data at some point.</em></p>
<p>Why? Imagine a perfectly connected object graph, one where each Core Data object is connected to every other object through a series of relationships. If Core Data didn&#x2019;t put limits on the information a fetch request returned, you&#x2019;d be fetching the entire object graph every single time! That&#x2019;s not memory efficient.</p>
<p>&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x8981;&#x5BF9;&#x83B7;&#x53D6;&#x7684;&#x8BF7;&#x6C42;&#x52A0;&#x4EE5;&#x9650;&#x5236;&#xFF0C;&#x597D;&#x5728;&#x6211;&#x4EEC;&#x6709;&#x5F88;&#x591A;&#x79CD;&#x624B;&#x6BB5;&#xFF1A;<br>There are ways you can manually limit the information you get back from a fetch request. For example, NSFetchRequest supports fetching batches. You can use the properties fetchBatchSize, fetchLimit and fetchOffset to control the batching behavior.</p>
<p>Yet another way to limit your object graph is to use predicates, as you&#x2019;ve done to populate the venue count labels above.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> offeringDealPredicate: <span class="type">NSPredicate</span> = {</span><br><span class="line">   <span class="keyword">var</span> pr = <span class="type">NSPredicate</span>(format: <span class="string">&quot;specialCount &gt; 0&quot;</span>)</span><br><span class="line">   <span class="keyword">return</span> pr</span><br><span class="line">}()</span><br><span class="line"></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> walkingDistancePredicate: <span class="type">NSPredicate</span> = {</span><br><span class="line">   <span class="keyword">var</span> pr = <span class="type">NSPredicate</span>(format: <span class="string">&quot;location.distance &lt; 500&quot;</span>)</span><br><span class="line">   <span class="keyword">return</span> pr</span><br><span class="line">}()</span><br><span class="line"></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> hasUserTipsPredicate: <span class="type">NSPredicate</span> = {</span><br><span class="line">   <span class="keyword">var</span> pr = <span class="type">NSPredicate</span>(format: <span class="string">&quot;stats.tipCount &gt; 0&quot;</span>)</span><br><span class="line">   <span class="keyword">return</span> pr</span><br><span class="line">}()</span><br></pre></td></tr></table></figure>
<p>&#x540C;&#x65F6;&#x8865;&#x5168;tableViewDelegate&#x4E2D;&#x7684;&#x5185;&#x5BB9;<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//MARK: - UITableViewDelegate methods</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView, didSelectRowAtIndexPath indexPath: NSIndexPath)</span></span> {</span><br><span class="line">    <span class="keyword">let</span> cell = tableView.cellForRowAtIndexPath(indexPath)!</span><br><span class="line">    <span class="comment">// &#x4E0D;&#x540C;&#x7684;cell&#xFF0C;&#x5BF9;&#x5E94;&#x4E0D;&#x7528;&#x7684;predicate</span></span><br><span class="line">    <span class="keyword">switch</span> cell {</span><br><span class="line">      <span class="comment">// PRICE section</span></span><br><span class="line">      <span class="keyword">case</span> cheapVenueCell:</span><br><span class="line">          selectedPredicate = cheapVenuePredicate</span><br><span class="line">      <span class="keyword">case</span> moderateVenueCell:</span><br><span class="line">          selectedPredicate = moderateVenuePredicate</span><br><span class="line">      <span class="keyword">case</span> expensiveVenueCell:</span><br><span class="line">          selectedPredicate = expensiveVenuePredicate</span><br><span class="line">      <span class="comment">// POPULATE section</span></span><br><span class="line">      <span class="keyword">case</span> offeringDealCell:</span><br><span class="line">          selectedPredicate = offeringDealPredicate</span><br><span class="line">      <span class="keyword">case</span> walkingDistanceCell:</span><br><span class="line">          selectedPredicate = walkingDistancePredicate</span><br><span class="line">      <span class="keyword">case</span> userTipsCell:</span><br><span class="line">          selectedPredicate = hasUserTipsPredicate</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;default case&quot;</span>)</span><br><span class="line">     }       cell.accessoryType = <span class="type">UITableViewCellAccessoryType</span>.<span class="type">Checkmark</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x501F;&#x52A9;&#x4EE3;&#x7406;&#x4F20;&#x56DE;&#x5230;&#x4E3B;&#x63A7;&#x5236;&#x5668;&#xFF0C;&#x63A7;&#x5236;&#x5237;&#x65B0;&#x4E3B;&#x754C;&#x9762;&#x7684;venue&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x6309;&#x7167;&#x6307;&#x5B9A;&#x8981;&#x6C42;&#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x6570;&#x636E;&#x7684;&#x76EE;&#x7684;&#xFF0D;&#xFF0D;&#x4E5F;&#x5C31;&#x662F;&#x201C;&#x67E5;&#x627E;&#x201D;&#x529F;&#x80FD;</p>
<hr>
<p>&#x63A5;&#x4E0B;&#x6765;&#x66F4;&#x8FDB;&#x4E00;&#x6B65;&#xFF0C;&#x5728;&#x73B0;&#x5B9E;&#x4E2D;&#xFF0C;&#x5728;&#x67E5;&#x627E;&#x4E4B;&#x4F59;&#x80FD;&#x6392;&#x5E8F;&#x7684;&#x9700;&#x6C42;&#x66F4;&#x52A0;&#x5E7F;&#x6CDB;&#xFF0C;&#x6240;&#x4EE5;coreData&#x4E5F;&#x4E3A;&#x6211;&#x4EEC;&#x51C6;&#x5907;&#x4E86;&#x65B9;&#x4FBF;&#x7684;&#x5DE5;&#x5177;NSSortDescriptor&#xFF0C;&#x5E76;&#x4E14;&#x5176;&#x7528;&#x6CD5;&#x8DDF;&#x5355;&#x7EAF;&#x8D1F;&#x8D23;&#x67E5;&#x627E;&#x7684;NSPredicte&#x662F;&#x5206;&#x7C7B;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4ECD;&#x65E7;&#x9996;&#x5148;&#x505A;lazy&#xFF1A;<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MARK: - lazy SortDescriptor</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x6309;&#x59D3;&#x540D;&#x6392;&#x5E8F;</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> nameSortDescriptor: <span class="type">NSSortDescriptor</span> = {</span><br><span class="line">   <span class="keyword">var</span> sd = <span class="type">NSSortDescriptor</span>(key: <span class="string">&quot;name&quot;</span>, ascending: <span class="literal">true</span>, selector: <span class="string">&quot;localizedStandardCompare:&quot;</span>) <span class="comment">// &#x5C31;&#x662F;&#x8981;&#x753B;&#x86C7;&#x6DFB;&#x8DB3;&#x600E;&#x7684;</span></span><br><span class="line">   <span class="keyword">return</span> sd</span><br><span class="line">   }()</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x6309;&#x8DDD;&#x79BB;&#x6392;&#x5E8F;</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> distanceSortDescriptor: <span class="type">NSSortDescriptor</span> = {</span><br><span class="line">   <span class="keyword">var</span> sd = <span class="type">NSSortDescriptor</span>(key: <span class="string">&quot;location.distance&quot;</span>, ascending: <span class="literal">true</span>)</span><br><span class="line">   <span class="keyword">return</span> sd</span><br><span class="line">   }()</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#x6309;&#x5047;&#x671F;&#x6392;&#x5E8F;</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> priceSortDescriptor: <span class="type">NSSortDescriptor</span> = {</span><br><span class="line">   <span class="keyword">var</span> sd = <span class="type">NSSortDescriptor</span>(key: <span class="string">&quot;piceInfo.priceCategory&quot;</span>, ascending: <span class="literal">true</span>)</span><br><span class="line">   <span class="keyword">return</span> sd</span><br><span class="line">   }()</span><br></pre></td></tr></table></figure></p>
<p>To initialize an instance of NSSortDescriptor you need three things: a key path to specify the attribute by which you want to sort, a specification of whether the sort is ascending or descending and an optional selector.</p>
<p><code>NSSortDescriptor</code>&#x7684;&#x5B9E;&#x4F8B;&#x8BDD;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6307;&#x660E;3&#x4E2A;&#x4E1C;&#x897F;&#xFF1A;key&#xFF0D;&#xFF0D;&#x8868;&#x793A;&#x5BF9;&#x8C01;&#x6392;&#x5E8F;&#xFF0C;&#x5E03;&#x5C14;&#x7684;ascending&#xFF0D;&#xFF0D;&#x6307;&#x5B9A;&#x964D;&#x5E8F;&#x8FD8;&#x662F;&#x5347;&#x5E8F;&#xFF0C;&#x4EE5;&#x53CA;&#x53EF;&#x9009;&#x7684;selector&#xFF0D;&#xFF0D;&#x9488;&#x5BF9;&#x5176;&#x4ED6;&#x7279;&#x6B8A;&#x8981;&#x6C42;&#x3002;&#x4E0D;&#x4F7F;&#x7528;&#x53EF;&#x9009;&#x7684;selector&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F1A;&#x9ED8;&#x8BA4;&#x8C03;&#x7528;<code>localizedStandardCompare</code> &#x65B9;&#x6CD5;&#x505A;&#x4E00;&#x4E9B;&#x521A;&#x521A;&#x591F;&#x7528;&#x7684;&#x6392;&#x5E8F;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7279;&#x6B8A;&#x8981;&#x6C42;&#xFF0C;&#x90A3;&#x5C31;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;selector&#x5427;&#xFF01;</p>
<p>&#x6B64;&#x5916;&#x989D;&#x5916;&#x7684;&#x8865;&#x5145;&#x4E00;&#x70B9;&#x513F;&#xFF1A;coreData&#x4E2D;&#x7684;NSSortDescriptor&#x548C;NSPredicate&#xFF0C;&#x90FD;&#x4E0D;&#x652F;&#x6301;&#x5728;&#x5904;&#x7406;&#x6570;&#x7EC4;&#x7B49;&#x96C6;&#x5408;&#x4E2D;&#x5E38;&#x89C1;&#x7684;&#x7684;Block&#x5F0F;&#x7684;API&#xFF0C;&#x8FD9;&#x662F;&#x51FA;&#x4E8E;&#x8FD9;&#x6837;&#x7684;&#x8003;&#x8651;&#xFF1A;&#x6392;&#x5E8F;&#x548C;&#x67E5;&#x627E;&#x90FD;&#x662F;SQLite&#x5C42;&#x7EA7;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x9700;&#x8981;&#x7CFB;&#x7EDF;&#x80FD;&#x5FEB;&#x901F;&#x7684;&#x53D8;&#x6210;SQL&#x8BED;&#x53E5;&#x3002;</p>
<blockquote>
<p>The reason is related to the fact that filtering/sorting happens in the SQLite database, so the predicate/sort descriptor has to match nicely to something that can be written as an SQLite statement.</p>
</blockquote>
<p>OK&#xFF0C;&#x8FD8;&#x662F;&#x8BF4;&#x56DE;&#x6765;&#xFF0C;&#x7EE7;&#x7EED;&#x5B8C;&#x6210;&#x6392;&#x5E8F;&#x529F;&#x80FD;&#xFF0C;&#x53BB;&#x6DFB;&#x52A0;&#x6392;&#x5E8F;&#x5B9E;&#x4F8B;&#x7136;&#x540E;&#x5E76;&#x901A;&#x8FC7;&#x4EE3;&#x7406;&#x4F20;&#x9012;&#x5230;&#x4E3B;&#x63A7;&#x5236;&#x5668;&#x3002;let&#x2019;s go down to didSelectRowAtIndexPath and add the following cases to the end of the switch statement:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SORT section</span></span><br><span class="line"><span class="keyword">case</span> nameAZSortCell:</span><br><span class="line">   selectedSortDescriptor = nameSortDescriptor</span><br><span class="line"><span class="keyword">case</span> nameZASortCell:</span><br><span class="line">   selectedSortDescriptor = nameSortDescriptor.reversedSortDescriptor <span class="keyword">as</span>? <span class="type">NSSortDescriptor</span></span><br><span class="line"><span class="keyword">case</span> distanceSortCell:</span><br><span class="line">   selectedSortDescriptor = distanceSortDescriptor</span><br><span class="line"><span class="keyword">case</span> priceSortCell:</span><br><span class="line">  selectedSortDescriptor = priceSortDescriptor</span><br></pre></td></tr></table></figure>
<p>&#x622A;&#x6B62;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#xFF0C;&#x529F;&#x80FD;&#x90E8;&#x5206;&#x5B9E;&#x73B0;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x6709;&#x4E00;&#x4E2A;&#x574F;&#x6D88;&#x606F;&#x662F;&#x76EE;&#x524D;&#x7684;request&#x90FD;&#x662F;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF0C;&#x8FD9;&#x663E;&#x7136;&#x662F;&#x4E00;&#x4E2A;&#x4F18;&#x8D28;&#x5E94;&#x7528;&#x5E94;&#x8BE5;&#x907F;&#x514D;&#x7684;&#xFF0C;&#x73B0;&#x5728;&#x7684;demo&#x8FD0;&#x884C;&#x8D77;&#x6765;&#x5E76;&#x4E0D;&#x5361;&#x662F;&#x5E94;&#x4E3A;&#x8FC7;&#x4E8E;&#x7B80;&#x5355;&#xFF0C;&#x6240;&#x4EE5;&#x8BF7;&#x6C42;&#x7684;&#x5F02;&#x90E8;&#x5316;&#x662F;&#x5FC5;&#x7136;&#x7684;&#x3002;</p>
<hr>
<p><strong>Asynchronous fetching</strong></p>
<p>&#x6B63;&#x662F;&#x8003;&#x8651;&#x5230;&#x4E3B;&#x7EBF;&#x7A0B;&#x5360;&#x7528;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x6240;&#x4EE5;&#x5728;iOS8&#x4E4B;&#x540E;&#xFF0C;&#x82F9;&#x679C;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x65B0;&#x7684;&#x8BF7;&#x6C42;&#xFF1A; <code>NSAsynchronousFetchRequest</code>&#xFF0C;&#x770B;&#x8D77;&#x6765;&#x5C31;&#x50CF;&#x662F;&#x5BF9;&#x65E7;&#x7684;<code>NSFetchRequest</code>&#x4E00;&#x4E2A;&#x5F02;&#x6B65;&#x7684;&#x5305;&#x88C5;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x5B9E;&#x4F8B;&#x5316;&#x9700;&#x8981;&#x666E;&#x901A;&#x7684;<code>NSFetchRequest</code>&#xFF0C;&#x5728;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x5C31;&#x80FD;&#x770B;&#x51FA;&#xFF0C;&#x5BF9;&#x5E94;&#x4E8E;&#x5F02;&#x6B65;&#x8BF7;&#x6C42;&#xFF0C;&#x51FA;&#x73B0;&#x5F02;&#x6B65;&#x7ED3;&#x679C; <code>NSAsynchronousFetchResult</code>&#x5C31;&#x662F;&#x5F88;&#x81EA;&#x7136;&#x4E86;&#xFF0C;&#x540C;&#x65F6;&#x8FD8;&#x9700;&#x8981;&#x6709;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;&#x56DE;&#x8C03;&#xFF0C;&#x7B49;&#x4E0D;&#x53CA;&#x4E86;&#x76F4;&#x63A5;&#x4E0A;&#x4EE3;&#x7801;&#xFF0C;&#x5728;&#x4E3B;&#x63A7;&#x5236;&#x5668;&#x7684;<code>ViewDidLoad</code>&#x4E2D;&#x66FF;&#x6362;&#x539F;&#x8BF7;&#x6C42;&#x4E3A;&#xFF1A;</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 1 &#x521B;&#x5EFA;&#x8BF7;&#x6C42;</span></span><br><span class="line">fetchRequest = <span class="type">NSFetchRequest</span>(entityName: <span class="string">&quot;Venue&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 &#x5F02;&#x6B65;&#x8BF7;&#x6C42; &#xFF0B; &#x5B8C;&#x6210;&#x56DE;&#x8C03;&#x66F4;&#x65B0;UI</span></span><br><span class="line">asyncFetchRequest = <span class="type">NSAsynchronousFetchRequest</span>(fetchRequest: fetchRequest, completionBlock: {</span><br><span class="line">     (results: <span class="type">NSAsynchronousFetchResult</span>) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">         <span class="keyword">self</span>.venues = results.finalResult <span class="keyword">as</span>! [<span class="type">Venue</span>]</span><br><span class="line">         <span class="keyword">self</span>.tableView.reloadData()</span><br><span class="line">})</span><br><span class="line"><span class="comment">// 3 &#x6267;&#x884C;&#x8BF7;&#x6C42;</span></span><br><span class="line"><span class="keyword">do</span> {</span><br><span class="line">     <span class="keyword">let</span> results = <span class="keyword">try</span> coreDataStack.context.executeRequest(asyncFetchRequest)</span><br><span class="line">     <span class="keyword">let</span> persistentStoreResults = results</span><br><span class="line">}<span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> {</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">&quot;&#x672A;&#x80FD;&#x6210;&#x529F;&#x83B7;&#x53D6;\(error),\(error.userInfo)&quot;</span>)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4F46;&#x5982;&#x679C;&#x6B64;&#x65F6;&#x7F16;&#x8BD1;&#x8FD0;&#x884C;&#x4F1A;&#x51FA;&#x73B0;&#x8FD9;&#x6837;&#x7684;&#x9519;&#x8BEF;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSConfinementConcurrencyType context &lt;NSManagedObjectContext: 0x7f8eb3c130f0&gt; cannot support asynchronous fetch request &lt;NSAsynchronousFetchRequest: 0x7f8eb3e229e0&gt; with fetch request &lt;NSFetchRequest: 0x7f8eb3ea9580&gt;.</span><br></pre></td></tr></table></figure>
<p>&#x5B9E;&#x9645;&#x4E0A;&#x666E;&#x901A;&#x7684;<code>NSManagedObjectContext</code>&#x5E76;&#x4E0D;&#x80FD;&#x652F;&#x6301;&#x5F02;&#x6B65;&#x7684;&#x8BF7;&#x6C42;&#x65B9;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x8FD8;&#x6709;&#x5176;&#x4ED6;2&#x4E2A;&#x6B65;&#x9AA4;&#x9700;&#x8981;&#x53D8;&#x66F4;</p>
<ul>
<li>first,&#x662F;<code>coreDataStack</code> &#x4E2D;&#x7684;<code>managedContext</code>&#x7684;&#x5B9E;&#x4F8B;&#x8BDD;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6307;&#x5B9A;&#x7684;&#x5E76;&#x53D1;&#x7C7B;&#x578B;&#xFF1A;</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// &#x6307;&#x5B9A;&#x5E76;&#x53D1;&#x7C7B;&#x578B;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x5B9E;&#x4F8B;</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line">NSManagedObjectContextConcurrencyType.ConfinementConcurrencyType  // &#x9ED8;&#x8BA4;</span><br><span class="line">NSManagedObjectContextConcurrencyType.PrivateQueueConcurrencyType // &#x591A;&#x7EBF;&#x7A0B;</span><br><span class="line">NSManagedObjectContextConcurrencyType.MainQueueConcurrencyType // &#x4E3B;&#x7EBF;&#x7A0B;&#x5E76;&#x53D1;</span><br><span class="line">*/</span></span><br><span class="line">context = <span class="type">NSManagedObjectContext</span>(concurrencyType: <span class="type">NSManagedObjectContextConcurrencyType</span>.<span class="type">MainQueueConcurrencyType</span>)</span><br></pre></td></tr></table></figure>
<p>&#x6709;3&#x79CD;&#x7C7B;&#x578B;&#x4F9B;&#x9009;&#x62E9;&#xFF0C;&#x9ED8;&#x8BA4;&#x7684;&#x5E76;&#x53D1;&#x7C7B;&#x578B;&#x662F;<code>&#x201C;.ConfinementConcurrencyType&#x201D;</code>&#xFF0C;&#x4F46; <em>The problem is that this concurrency type is an old pattern that is all but deprecated.</em> &#x8FD8;&#x6709;  <code>&#x201C;.PrivateQueueConcurrencyType&quot;</code>&#x7C7B;&#x578B;&#xFF0C;&#x662F;&#x5728;&#x591A;&#x7EBF;&#x7A0B;&#x4E2D;&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x5148;&#x5F80;&#x540E;&#x653E;&#x3002;&#x5982;&#x679C;&#x6B64;&#x65F6;&#x8FD0;&#x884C;&#xFF0C;&#x5C31;&#x4F1A;&#x62A5;&#x8FD9;&#x6837;&#x7684;&#x9519;&#x8BEF;&#xFF1A;</p>
<blockquote>
<p>fatal error: unexpectedly found nil while unwrapping an Optional value</p>
</blockquote>
<ul>
<li>second&#xFF0C;&#x8FD9;&#x4E2A;&#x9519;&#x8BEF;&#x662F;swift&#x7F16;&#x7A0B;&#x4E2D;&#x7684;&#x8001;&#x9762;&#x5B54;&#xFF0C;&#x539F;&#x56E0;&#x5C31;&#x662F;&#x5C1D;&#x8BD5;&#x5F3A;&#x5236;&#x89E3;&#x5305;&#x4E00;&#x4E2A;&#x53EF;&#x9009;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x81EA;&#x8BA4;&#x4E3A;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x505A;&#x5230;&#x5F88;&#x6CE8;&#x610F;&#x7C7B;&#x578B;&#x7684;&#x8BDD;&#xFF0C;&#x53EF;&#x80FD;&#x5C31;&#x80FD;&#x731C;&#x5230;&#x539F;&#x56E0;&#xFF0C;&#x53EF;&#x60DC;&#x5728;&#x5E76;&#x53D1;&#x573A;&#x666F;&#x4E0B;&#x6211;&#x6CA1;&#x80FD;&#x6CE8;&#x610F;&#x5230;&#xFF0C;Since the original fetch request is asynchronous, it will finish after the table view does its initial load. The table view will try to unwrap the venues property but since there are no results yet, your app will crash.&#x770B;&#x6765;&#x5728;swift&#x7684;&#x5E76;&#x53D1;&#x4E4B;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x957F;&#x8FD9;&#x6837;&#x4E00;&#x4E2A;&#x201C;&#x5FC3;&#x773C;&#x201D;&#x3002;&#x66F4;&#x6539;&#x5982;&#x4E0B;&#xFF1A;</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> venues: [<span class="type">Venue</span>]! = []</span><br></pre></td></tr></table></figure>
<p>You fix this issue by initializing venues to an empty array. This way, on first load, if there are no results yet, your table view will simply be empty.</p>
<hr>
<p><strong>Batch Updates&#xFF1A;no fetch request</strong></p>
<p>Sometimes, the only reason you fetch objects from Core Data is to mutate an attribute. Then, after you make your changes, you have to commit the Core Data objects back to the persistent store and call it a day. This is the normal process you&#x2019;ve been following all along.<br>&#x901A;&#x5E38;&#xFF0C;&#x4ECE;coredata&#x83B7;&#x53D6;&#x5BF9;&#x8C61;&#x7684;&#x552F;&#x4E00;&#x7406;&#x7531;&#x662F;&#x60F3;&#x66F4;&#x6539;&#x5176;&#x7684;&#x4E00;&#x4E2A;&#x5C5E;&#x6027;&#xFF0C;&#x5E76;&#x5728;&#x66F4;&#x6539;&#x4E4B;&#x540E;&#x6DFB;&#x52A0;&#x5230;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x518D;commit&#x56FA;&#x5316;&#x4E4B;&#xFF0C;&#x8FD9;&#x662F;&#x6700;&#x5E38;&#x89C1;&#x7684;&#x6D41;&#x7A0B;&#x3002;</p>
<p>But What if you want to update a hundred thousand records all at once? It would take a lot of time and a lot of memory to fetch all of those objects just to update one attribute. No amount of tweaking your fetch request would save your user from having to stare at a spinner for a long, long time.<br>&#x4F46;&#x662F;&#x5982;&#x679C;&#x8003;&#x8651;&#x4E00;&#x4E0B;&#x573A;&#x666F;&#xFF1A;&#x5982;&#x679C;&#x4F60;&#x9700;&#x8981;&#x4E00;&#x6B21;&#x6027;&#x66F4;&#x65B0;10&#x4E07;&#x6761;&#x7EAA;&#x5F55;&#xFF0C;&#x8FD9;&#x6837;&#x91CF;&#x7EA7;&#x7684;&#x6570;&#x636E;&#x4F1A;&#x8D39;&#x5927;&#x91CF;&#x7684;&#x65F6;&#x95F4;&#x548C;&#x5185;&#x5B58;&#x53BB;&#x8BF7;&#x6C42;&#x6240;&#x6709;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x8C03;&#x6574;&#x8BF7;&#x6C42;&#x662F;&#x5FC5;&#x987B;&#x7684;&#x3002;</p>
<p>&#x5E78;&#x8FD0;&#x7684;&#x662F;&#x5728;iOS8&#x4E4B;&#x4E2D;&#xFF0C;&#x82F9;&#x679C;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x65B0;&#x7684;&#x4E0D;&#x9700;&#x8981;&#x8BF7;&#x6C42;&#x548C;&#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x7684;&#x6279;&#x91CF;&#x66F4;&#x65B0;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x65B0;&#x6280;&#x672F;&#x5141;&#x8BB8;&#x8D8A;&#x8FC7;&#x4E0A;&#x4E0B;&#x6587;&#xFF08;<code>NSManagedObjectContext</code>&#xFF09;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x56FA;&#x5316;&#x64CD;&#x4F5C;&#xFF0C;let&#x2019;s see this in practice&#xFF1A;</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: &#x6279;&#x91CF;&#x65E0;&#x8BF7;&#x6C42;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">batchNoFetch</span><span class="params">()</span></span> {</span><br><span class="line"><span class="comment">// &#x6279;&#x91CF;&#x8BF7;&#x6C42;&#xFF1A;&#x6307;&#x660E;&#x66F4;&#x65B0;&#x5C5E;&#x6027; &#x6307;&#x660E;&#x4F5C;&#x7528;&#x5B58;&#x50A8; &#x6307;&#x660E;&#x7ED3;&#x679C;&#x7C7B;&#x578B;</span></span><br><span class="line">     <span class="keyword">let</span> batchUpdate = <span class="type">NSBatchUpdateRequest</span>(entityName: <span class="string">&quot;Venue&quot;</span>)</span><br><span class="line">     batchUpdate.propertiesToUpdate = [<span class="string">&quot;favorite&quot;</span>: <span class="type">NSNumber</span>(bool: <span class="literal">true</span>)]</span><br><span class="line">     batchUpdate.affectedStores = coreDataStack.psc.persistentStores            batchUpdate.resultType = <span class="type">NSBatchUpdateRequestResultType</span>.<span class="type">UpdatedObjectsCountResultType</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// &#x6267;&#x884C; - &#x8FD4;&#x56DE;NSBatchUpdateResult</span></span><br><span class="line">      <span class="keyword">do</span> {</span><br><span class="line">          <span class="keyword">let</span> result = <span class="keyword">try</span>                                                     coreDataStack.context.executeRequest(batchUpdate) <span class="keyword">as</span>! <span class="type">NSBatchUpdateResult</span></span><br><span class="line"></span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;&#x66F4;&#x65B0;&#x8BB0;&#x5F55;&#xFF1A;\(result.result)&quot;</span>)</span><br><span class="line">     }<span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> {</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;&#x672A;&#x80FD;&#x6279;&#x91CF;&#x66F4;&#x65B0;\(error),\(error.userInfo)&quot;</span>)</span><br><span class="line">     }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x4F7F;&#x7528;&#x8D77;&#x6765;&#x8FD8;&#x662F;&#x76F8;&#x5F53;&#x65B9;&#x4FBF;&#x7684;&#xFF0C;&#x6307;&#x660E;&#x64CD;&#x4F5C;&#x5C5E;&#x6027;&#xFF0C;&#x4F5C;&#x7528;&#x5B58;&#x50A8;&#x548C;&#x8BBE;&#x7F6E;&#x7C7B;&#x578B;&#x7740;&#x8001;&#x4E00;&#x5957;&#xFF0C;&#x53EA;&#x662F;&#x7ED3;&#x679C;&#x5C31;&#x662F; <code>NSBatchUpdateResult</code>&#x4E86;&#xFF0C;&#x5F53;&#x7136;&#x5982;&#x679C;&#x4F60;&#x53EB;&#x677F;&#x79FB;&#x52A8;&#x7AEF;&#x6CA1;&#x6709;&#x8FD9;&#x4E48;&#x5927;&#x89C4;&#x6A21;&#x7684;&#x6570;&#x636E;&#x90A3;&#x6211;&#x4E5F;&#x6CA1;&#x529E;&#x6CD5;&#x4E86;</p>


<!--<a href="http://13hoop.github.io/2015/03/16/CoreData-三/#disqus_thread" class="article-comment-link">Comments</a>-->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = '13hoopgithub'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=undefined&web_id=undefined" language="JavaScript"></script>script>
</div>







</body>
</html>